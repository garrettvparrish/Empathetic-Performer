<!DOCTYPE html>
<html>

<head>
	<script type="text/javascript" src="./jquery-1.11.1.min.js"></script>
	<script type="text/javascript"> 
		$(function () {
			console.log("AGAIN?");
		    // Future-proofing...
		    var context;
		    if (typeof AudioContext !== "undefined") {
		        context = new AudioContext();
		    } else if (typeof webkitAudioContext !== "undefined") {
		        context = new webkitAudioContext();
		    } else {
		        $(".hideIfNoApi").hide();
		        $(".showIfNoApi").show();
		        return;
		    }

		    ////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////

		    // Web socket connections
		    var uuid = "";
		    var synchronizationSocket;

			var send_message = function (key, d) {
				synchronizationSocket.send(JSON.stringify({message: key, id: uuid, data: d}));
			}

		    setTimeout(function () {
				synchronizationSocket = new WebSocket("ws://localhost:3000", "protocolOne");
				
				synchronizationSocket.onopen = function (event) {
					console.log("Socket connection opened.");
				};


				synchronizationSocket.onmessage = function (event) {
					var obj = JSON.parse(event.data);
					uuid = obj['id'];
					var message = obj['message'];
					// Establishing a new connection
					if (message == 'connection') {
						var res = {message: "sync-handshake", id: uuid};
					  	synchronizationSocket.send(JSON.stringify(res)); 
					} else if (message == 'start-sync') {
						console.log("Starting sync");
						var water = document.getElementById('water');
						water.play();
					}
				}
		    }, 2000);
		    
		    ////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////
			////////////////////////////////////////////////////////
		    
		    var lastTime = 0;
		    var vendors = ['ms', 'moz', 'webkit', 'o'];
		    for (var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
		        window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];
		        window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame']
		                                    || window[vendors[x] + 'CancelRequestAnimationFrame'];
		    }

		    if (!window.requestAnimationFrame)
		        window.requestAnimationFrame = function (callback, element) {
		            var currTime = new Date().getTime();
		            var timeToCall = Math.max(0, 16 - (currTime - lastTime));
		            var id = window.setTimeout(function () { callback(currTime + timeToCall); },
		                timeToCall);
		            lastTime = currTime + timeToCall;
		            return id;
		        };

		    if (!window.cancelAnimationFrame)
		        window.cancelAnimationFrame = function (id) {
		            clearTimeout(id);
		        };

		    // Create the analyser
		    var analyser = context.createAnalyser();
		    analyser.fftSize = 64;
		    var frequencyData = new Uint8Array(analyser.frequencyBinCount);

		    var min = 65;
		    var max = 140;

		    // Get the frequency data and update the visualisation
		    function update() {
		        requestAnimationFrame(update);

		        analyser.getByteFrequencyData(frequencyData);
		        var sum = 0
		        for (i in frequencyData) {
		        	sum += frequencyData[i];
		        }
		        var avg = sum / frequencyData.length;
		        var normalized = (avg-min)/(max-min);
		        normalized = normalized < 0.0 ? 0.0 : normalized;
		        normalized = normalized > 1.0 ? 1.0 : normalized;

		        // triggered audio data
		        if (normalized != 0) {
			        console.log(normalized);	
			        send_message("sync-audio", normalized)	        	
		        }
		    };

		    // Hook up the audio routing...
		    // player -> analyser -> speakers
			$("#water").bind('canplay', function() {
				var source = context.createMediaElementSource(this);
				source.connect(analyser);
				analyser.connect(context.destination);
			});
	
		    update();
		});

	</script>
</head>

<body>
	<audio id="water" src="water.m4a" preload="auto"></audio>
</body>

</html>